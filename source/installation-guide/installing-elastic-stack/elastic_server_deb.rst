.. _elastic_server_deb:

Install Elastic Stack with Debian packages
===========================================

The DEB package is suitable for Debian, Ubuntu, and other Debian-based systems.

.. note:: Many of the commands described below need to be executed with root user privileges.

Preparation
-----------

1. Oracle Java JRE is required by Logstash and Elasticsearch:

  a) For Debian:

  .. code-block:: bash

    $ echo "deb http://ppa.launchpad.net/webupd8team/java/ubuntu xenial main" | tee /etc/apt/sources.list.d/webupd8team-java.list
    $ echo "deb-src http://ppa.launchpad.net/webupd8team/java/ubuntu xenial main" | tee -a /etc/apt/sources.list.d/webupd8team-java.list
    $ apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys EEA14886

  b) For Ubuntu:

  .. code-block:: bash

	 $ add-apt-repository ppa:webupd8team/java

2. Once the repository is added, install Java JRE:

  .. code-block:: bash

  	$ apt-get update
  	$ apt-get install oracle-java8-installer

3. Install the Elastic repository and its GPG key:

  .. code-block:: bash

  	$ apt-get install curl apt-transport-https
  	$ curl -s https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -
  	$ echo "deb https://artifacts.elastic.co/packages/5.x/apt stable main" | tee /etc/apt/sources.list.d/elastic-5.x.list
  	$ apt-get update

Elasticsearch
-------------

Elasticsearch is a highly scalable full-text search and analytics engine. For more info please see `Elasticsearch <https://www.elastic.co/products/elasticsearch>`_.

1. Install the Elasticsearch package:

  .. code-block:: bash

    $ apt-get install elasticsearch=|ELASTICSEARCH_LATEST|

2. Enable and start the Elasticsearch service:

  a) For Systemd:

  .. code-block:: bash

    $ systemctl daemon-reload
    $ systemctl enable elasticsearch.service
    $ systemctl start elasticsearch.service

  b) For SysV Init:

  .. code-block:: bash

  	$ update-rc.d elasticsearch defaults 95 10
  	$ service elasticsearch start

3. Load Armor Elasticsearch template:

  .. code-block:: bash

  	$ curl https://raw.githubusercontent.com/armor/armor-kibana-app/2.1/server/startup/integration_files/template_file.json | curl -XPUT 'http://localhost:9200/_template/armor' -H 'Content-Type: application/json' -d @-

4. Insert sample alert:

  .. code-block:: bash

  	$ curl https://raw.githubusercontent.com/armor/armor-kibana-app/2.1/server/startup/integration_files/alert_sample.json | curl -XPUT "http://localhost:9200/armor-alerts-"`date +%Y.%m.%d`"/armor/sample" -H 'Content-Type: application/json' -d @-

.. note::

    It is recommended to edit the default configuration to improve the Elasticsearch performance. To do so, please see :ref:`elastic_tuning`.

Logstash
--------

Logstash is the tool that will collect, parse, and forward to Elasticsearch for indexing and storage all logs generated by Armor server. For more info please see `Logstash <https://www.elastic.co/products/logstash>`_.

1. Install the Logstash package:

  .. code-block:: bash

    $ apt-get install logstash=1:|ELASTICSEARCH_LATEST|-1

2. Download the Armor config for Logstash:

  .. code-block:: bash

  	$ curl -so /etc/logstash/conf.d/01-armor.conf https://raw.githubusercontent.com/armor/armor/2.1/extensions/logstash/01-armor.conf

3. Download the Armor Logstash template:

  .. code-block:: bash

  	$ curl -so /etc/logstash/armor-elastic5-template.json https://raw.githubusercontent.com/armor/armor/2.1/extensions/elasticsearch/armor-elastic5-template.json

4. **Follow this step only if you are using a single-host architecture**:

  a) Edit ``/etc/logstash/conf.d/01-armor.conf``, commenting out the entire input section titled "Remote Armor Manager - Filebeat input" and uncommenting the entire input section titled "Local Armor Manager - JSON file input".  This will set up Logstash to read the Armor ``alerts.json`` file directly from the local filesystem rather than expecting Filebeat on a separate server to forward the information in that file to Logstash.

  b) Because the Logstash user needs to read alerts.json file, please add it to OSSEC group by running:

  .. code-block:: bash

    $ usermod -a -G ossec logstash


5. Enable and start the Logstash service:

  a) For Systemd:

  .. code-block:: bash

  	$ systemctl daemon-reload
  	$ systemctl enable logstash.service
  	$ systemctl start logstash.service

  b) For SysV Init:

  .. code-block:: bash

    $ update-rc.d logstash defaults 95 10
    $ service logstash start

.. note::

    If you are running Armor server and the Elastic Stack server on separate systems (**distributed architecture**), then it is important to configure encryption between Filebeat and Logstash. To do so, please see :ref:`elastic_ssl`.

Kibana
------

Kibana is a flexible and intuitive web interface for mining and visualizing the events and archives stored in Elasticsearch. More info at `Kibana <https://www.elastic.co/products/kibana>`_.

1. Install the Kibana package:

  .. code-block:: bash

   $ apt-get install kibana=|ELASTICSEARCH_LATEST|

2. Install the Armor App plugin for Kibana:

  .. code-block:: bash

    $ /usr/share/kibana/bin/kibana-plugin install https://packages.armor.com/armorapp/armorapp-|ARMOR_LATEST|_|ELASTICSEARCH_LATEST|.zip

  .. warning::

    The Kibana plugin installation process may take several minutes. Please wait patiently.

3. **Optional.** Kibana will listen only on the loopback interface (localhost) by default. To set up Kibana to listen on all interfaces, edit the file ``/etc/kibana/kibana.yml``. Uncomment the setting ``server.host`` and change the value to:

  .. code-block:: yaml

    server.host: "0.0.0.0"

  .. note::

    It is recommended to set up an Nginx proxy for Kibana in order to use SSL encryption and to enable authentication. Instructions to set the proxy up can be found at :ref:`kibana_ssl`.

4. Enable and start the Kibana service:

  a) For Systemd:

  .. code-block:: bash

  	$ systemctl daemon-reload
  	$ systemctl enable kibana.service
  	$ systemctl start kibana.service

  b) For SysV Init:

  .. code-block:: bash

   $ update-rc.d kibana defaults 95 10
   $ service kibana start

5. Disable the Elastic repository:

  We recommend to disable the Elasticsearch repository in order to prevent an upgrade to a newer Elastic Stack version due to possible breaking changes with our App, so you should do it as follow:

  .. code-block:: console

    $ sed -i -r '/deb https:\/\/artifacts.elastic.co\/packages\/5.x\/apt stable main/ s/^(.*)$/#\1/g' /etc/apt/sources.list.d/elastic-5.x.list

Connecting the Armor App with the API
-------------------------------------

Follow the next guide in order to connect the Armor App with the API:

.. toctree::
	:maxdepth: 1

	connect_armor_app
