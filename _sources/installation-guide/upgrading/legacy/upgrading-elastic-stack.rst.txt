.. _upgrading_elastic_stack:

Upgrading Elastic Stack server
==============================

Although Armor v2.x is compatible both with Elastic Stack 2.x and 5.x, it is recommended to run it with version 5.x, our Armor Kibana App it is not compatible with Elastic Stack 2.X. In any case, here is a brief description of the upgrade process, no matter which version of the cluster you decide to keep.

#. `Keep using Elastic Stack 2.x`_
#. `Upgrade from Elastic Stack 2.x to 5.x`_

Keep using Elastic Stack 2.x
----------------------------

In this scenario you will only need to configure Logstash to receive data from Filebeat (or directly read alerts generated by Armor server for a single-host architecture) and feed the Elasticsearch using the Armor alerts template:

Configure Logstash
^^^^^^^^^^^^^^^^^^

1. Download the new logstash configuration:

  .. code-block:: bash

    $ curl -so /etc/logstash/conf.d/01-armor.conf https://raw.githubusercontent.com/armor/armor/2.1/extensions/logstash/01-armor.conf
    $ curl -so /etc/logstash/armor-elastic2-template.json https://raw.githubusercontent.com/armor/armor/2.1/extensions/elasticsearch/armor-elastic2-template.json

2. In the output section of ``/etc/logstash/conf.d/01-armor.conf``, comment the line for ``elastic5-template`` and uncomment the line for ``elastic2-template``:

  .. code-block:: bash

    output {
      elasticsearch {
      hosts => ["localhost:9200"]
      index => "armor-alerts-%{+YYYY.MM.dd}"
      document_type => "armor"
            #      template => "/etc/logstash/armor-elastic5-template.json"
	          template => "/etc/logstash/armor-elastic2-template.json"
	          template_name => "armor"
	          template_overwrite => true
	    }
    }

3. *Only if you are using a single-host architecture* (where Armor server is running with Elastic Stack in the same host), edit ``/etc/logstash/conf.d/01-armor.conf`` commenting out the entire input section titled ``Remote Armor Manager - Filebeat input`` and uncommenting the entire input section titled ``Local Armor Manager - JSON file input``:

  .. code-block:: bash

    # Armor - Logstash configuration file
    ## Remote Armor Manager - Filebeat input
    #input {
    #beats {
    #      port => 5000
    #      codec => "json_lines"
    #      ssl => true
    #      ssl_certificate => "/etc/logstash/logstash.crt"
    #      ssl_key => "/etc/logstash/logstash.key"
    #  }
    #}
    # Local Armor Manager - JSON file input
    input {
       file {
           type => "armor-alerts"
           path => "/var/ossec/logs/alerts/alerts.json"
           codec => "json"
       }
    }
    ...

   The above will setup Logstash to read the Armor ``alerts.json`` file directly from the local filesystem rather than receive forwarded data from Filebeat.

Configure Kibana
^^^^^^^^^^^^^^^^

Next, in order to display Armor alerts data, we will configure Kibana index pattern.

1. Go to Settings and configure a new wildcard:

  .. thumbnail:: ../../../images/installation/kibana-elk2-set.png
    :align: center
    :width: 100%

2. Set ``armor-*`` as index pattern and choose ``timestamp`` as time field, then click on create:

  .. thumbnail:: ../../../images/installation/kibana-elk2.png
    :align: center
    :width: 100%

3. Set as default wildcard by clicking on the Star:

  .. thumbnail:: ../../../images/installation/kibana-elk.png
    :align: center
    :width: 100%

4. Go to the ``Discover`` tab in order to visualize the alerts data.

Upgrade from Elastic Stack 2.x to 5.x
-------------------------------------

Follow next steps to upgrade your Elastic Stack cluster to version 5.X:

1. Stop the running Logstash, Elasticsearch and Kibana instances:

  a) For Systemd:

    .. code-block:: bash

        $ systemctl stop logstash.service
        $ systemctl stop elasticsearch.service
        $ systemctl stop kibana.service

  b) For SysV Init:

    .. code-block:: bash

      $ service logstash stop
      $ service elasticsearch stop
      $ service kibana stop

2. Remove Logstash old configuration and template files:

  For single-host architectures (Armor server and Elastic Stack running in the same system):

  .. code-block:: bash

   $ rm /etc/logstash/conf.d/01-ossec-singlehost.conf
   $ rm /etc/logstash/elastic-ossec-template.json

  For distributed architectures (Elastic Stack standalone server):

  .. code-block:: bash

   $ rm /etc/logstash/conf.d/01-ossec.conf
   $ rm /etc/logstash/elastic-ossec-template.json

3. Remove deprecated settings from configuration file:

  Removing deprecated settings on Elasticsearch will avoid errors & conflicts after the upgrade, To do that, comment the following lines on your ``/etc/elasticsearch/elasticsearch.yml`` file:

  .. code-block:: yaml

    index.number_of_shards: 1
    index.number_of_replicas: 0

  ``ES_HEAP_SIZE`` option is now deprecated. You should remove or comment out this option in your  ``/etc/sysconfig/elasticsearch`` file:

  .. code-block:: bash

    # ES_HEAP_SIZE - Set it to half your system RAM memory
    ES_HEAP_SIZE=8g

  Now you can go ahead and configure it following the Elastic `jvm.options guide <https://www.elastic.co/guide/en/elasticsearch/reference/master/heap-size.html>`_

4. At this point, you could install the new version of Elastic Stack. Depending on your operating system you can follow one of these installation instructions:

    - :ref:`Install Elastic Stack with RPM packages <elastic_server_rpm>`
    - :ref:`Install Elastic Stack with DEB packages <elastic_server_deb>`

5. Let's check the software version of the different components to verify everything worked as expected:

  a) For Logstash:

    .. code-block:: bash

      $ /usr/share/logstash/bin/logstash -V
      logstash 5.2.2

  b) For Elasticsearch:

    .. code-block:: bash

      $ /usr/share/elasticsearch/bin/elasticsearch -V
      Version: 5.2.2, Build: f9d9b74/2017-02-24T17:26:45.835Z, JVM: 1.8.0_60

  c) For Kibana:

    .. code-block:: bash

      $ /usr/share/kibana/bin/kibana -V
      5.2.

.. note:: Armor v2.x uses different indices and templates than Armor v1.x For that reason, you will not be able to see the previous alerts using Kibana. If you need to access them, you will have to reindex the previous indices.
